#!/bin/bash

set -e

cd "$(readlink -f $(dirname "${BASH_SOURCE[0]}"))"
cd ..

./bin/build

if [ ! -d ~/assay ]; then
    echo "Downloading assay to ~/assay..."
    curl -L https://github.com/brandon-rhodes/assay/archive/master.tar.gz | tar xz
    mv assay-master ~/assay
fi

for version in 3.8 3.9 3.10 3.11 3.12 3.13 3.14
do
    echo
    echo $version
    echo
    venv=.tox/$version
    if [ ! -d $venv ]
    then
        uv venv --python $version $venv
    fi
    source $venv/bin/activate
    pushd ci
    uv pip install pytz pandas
    skyfield_wheel=$(ls -t ../dist/skyfield-*-py3-none-any.whl | head -1)
    uv pip install "$skyfield_wheel"
    uv pip install ~/assay
    assay --batch skyfield.tests
    popd
done
