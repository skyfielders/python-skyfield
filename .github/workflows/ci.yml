name: Skyfield CI
on: [push]
jobs:
  doctest-and-lint:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [
          "3.9", "3.10", "3.11", "3.12"
        ]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Display Python version
      run: |
        python -c "import sys; print(sys.version)"
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools
        pip install -r requirements.txt
    - name: Build and install Skyfield
      run: |
        python setup.py sdist
        pip install dist/*
    - name: Doctest
      run: |
        ./test-docs.sh
        grep "    0 failures in tests" ./documentation/_build/doctest/output.txt
        grep "    0 failures in setup code" ./documentation/_build/doctest/output.txt
        grep "    0 failures in cleanup code" ./documentation/_build/doctest/output.txt
    - name: Lint
      run: |
        pyflakes $(find skyfield/ -name '*.py')
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [
          "2.7", "3.7", "3.8", "3.9", "3.10", "3.11", "3.12"
        ]
    steps:
    - uses: actions/checkout@v4
    - if: ${{ matrix.python-version == '2.7' }}
      name: Set up Python ${{ matrix.python-version }}
      run: |
        sudo apt install python2
        curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output get-pip.py
        sudo python2 get-pip.py
    - if: ${{ matrix.python-version != '2.7' }}
      name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install and activate venv
      run: |
        sudo apt install -q -q python3-virtualenv virtualenv
        virtualenv -p python${{matrix.python-version}} V
        source ./V/bin/activate
        echo PATH=$PATH >> $GITHUB_ENV
    - name: Display Python version
      run: |
        python -c "import sys; print(sys.version)"
    - name: Install test dependencies
      run: |
        pip install --upgrade pip setuptools
        python -m pip install mock pandas
        python -m pip install https://github.com/brandon-rhodes/assay/archive/master.zip
    - name: Build and install Skyfield
      run: |
        python setup.py sdist
        pip install dist/*
    - name: Run tests
      run: |
        ./test-code.sh
